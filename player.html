<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Player Details — Prompt Game Tournament</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
<header class="site-header">
  <a class="btn link" href="./index.html">← Back</a>
  <h1>Player Details</h1>
  <div></div>
</header>

<main class="container">
  <section class="card" id="playerCard">
    <h2 id="playerName">Loading…</h2>
    <div class="grid two">
      <div>
        <ul class="kv">
          <li><span>Rank</span><strong id="rank">–</strong></li>
          <li><span>Rating μ</span><strong id="mu">–</strong></li>
          <li><span>Rating σ</span><strong id="sigma">–</strong></li>
          <li><span>Games</span><strong id="games">–</strong></li>
          <li><span>Wins</span><strong id="wins">–</strong></li>
          <li><span>Draws</span><strong id="draws">–</strong></li>
          <li><span>Losses</span><strong id="losses">–</strong></li>
          <li><span>Win Rate</span><strong id="winrate">–</strong></li>
        </ul>
      </div>
      <div><canvas id="playerWDL"></canvas></div>
    </div>
  </section>

  <section class="card" id="modelPromptCard">
    <div class="card-header">
      <h2>Model & Prompts</h2>
      <span id="modelBadge" class="badge model">Loading…</span>
    </div>

    <div id="promptBlocks" class="prompt-blocks"></div>
    <div id="promptMeta" class="prompt-meta"></div>
    <p id="promptError" class="muted" style="display:none;">
      Couldn’t find any YAML containing this player’s name in <code>data/prompt_collection/</code>.
    </p>
  </section>
</main>

<footer class="site-footer">
  <p><code>data/final_standings.csv</code> • <code>data/prompt_collection/*.yml</code></p>
</footer>

<script src="./utils.js"></script>
<script>
(async function () {
  const params = new URLSearchParams(window.location.search);
  const playerName = params.get('name');
  if (!playerName) {
    document.getElementById('playerName').textContent = 'No player specified.';
    return;
  }

  // ============ Load leaderboard info ============
  Papa.parse('data/final_standings.csv', {
    header: true,
    download: true,
    dynamicTyping: true,
    complete: (res) => {
      const row = res.data.find(r => String(r.Player) === playerName);
      if (!row) return;
      document.getElementById('playerName').textContent = row.Player;
      document.getElementById('rank').textContent = row.Rank;
      document.getElementById('mu').textContent = row.Rating_Mu;
      document.getElementById('sigma').textContent = row.Rating_Sigma;
      document.getElementById('games').textContent = row.Games;
      document.getElementById('wins').textContent = row.Wins;
      document.getElementById('draws').textContent = row.Draws;
      document.getElementById('losses').textContent = row.Losses;
      document.getElementById('winrate').textContent = formatPercent(row.Win_Rate);

      new Chart(document.getElementById('playerWDL'), {
        type: 'pie',
        data: { labels: ['Wins','Draws','Losses'],
                datasets:[{ data:[row.Wins,row.Draws,row.Losses] }] },
        options: { plugins:{legend:{position:'bottom'},
                            title:{display:true,text:'W/D/L Breakdown'}} }
      });
    }
  });

  // ============ Load YAML prompt/model ============
  const modelBadge = document.getElementById('modelBadge');
  const blocks = document.getElementById('promptBlocks');
  const meta = document.getElementById('promptMeta');
  const errEl = document.getElementById('promptError');

  function escapeHTML(s){
    return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function addBlock(title,content){
    const el=document.createElement('section');
    el.className='prompt-block';
    el.innerHTML=`<div class="prompt-block-title">${title}</div>
      <pre class="prompt-pre"><code>${escapeHTML(String(content))}</code></pre>`;
    blocks.appendChild(el);
  }
  function addMessages(messages){
    const sec=document.createElement('section');sec.className='prompt-block';
    sec.innerHTML='<div class="prompt-block-title">Messages</div>';
    const list=document.createElement('div');list.className='msg-list';
    messages.forEach(m=>{
      const role=m.role||m.speaker||'message',text=m.content??m.text??'';
      const div=document.createElement('div');div.className='msg';
      div.innerHTML=`<div class="msg-role">${escapeHTML(role)}</div>
                     <div class="msg-content"><pre><code>${escapeHTML(String(text))}</code></pre></div>`;
      list.appendChild(div);
    });
    sec.appendChild(list);blocks.appendChild(sec);
  }

  function pickModel(y){
    const direct=y.model||y.model_name||y.engine||y.backend||y.provider;
    if(typeof direct==='string') return direct;
    const paths=[['config','model'],['openai','model'],['api','model'],['model','name']];
    for(const p of paths){
      let node=y;for(const k of p) node=node?.[k];
      if(typeof node==='string') return node;
    }
    return 'Unknown model';
  }

  // Fuzzy filename search: fetch directory listing and find YAML whose name contains playerName
  async function findYamlFuzzy() {
    try {
      // Use GitHub raw directory API (works when served as GitHub Pages static)
      const listingUrl = 'data/prompt_collection/';
      const indexGuess = `${listingUrl}index.json`;
      // Try to read index.json (if exists) for speed
      const r = await fetch(indexGuess);
      if (r.ok) {
        const files = await r.json();
        const f = files.find(fn => fn.toLowerCase().includes(playerName.toLowerCase()) &&
                                   (fn.endsWith('.yml') || fn.endsWith('.yaml')));
        if (f) return `${listingUrl}${f}`;
      }
    } catch(e){/* ignore */}
    // fallback: try brute-force common endings
    const base='data/prompt_collection/';
    const lower=playerName.toLowerCase().replace(/\s+/g,'');
    const guesses=['.yml','.yaml'];
    for (const ext of guesses){
      const resp=await fetch(`${base}${playerName}${ext}`);
      if(resp.ok) return `${base}${playerName}${ext}`;
      const resp2=await fetch(`${base}${playerName.replace(/\s+/g,'_')}${ext}`);
      if(resp2.ok) return `${base}${playerName.replace(/\s+/g,'_')}${ext}`;
    }
    // last resort: try to scan likely numbered files
    // This generic fuzzy fallback is static-site safe: pre-known list could be inserted later.
    const pre = ['GPT4','GPT35','Claude','Gemini','OpenAI','Prompt','Chat'];
    for(const kw of pre){
      const test=`${base}${kw}_${playerName}.yml`;
      try{const r=await fetch(test);if(r.ok)return test;}catch(e){}
    }
    return null;
  }

  async function loadYamlFile() {
    const ymlPath = await findYamlFuzzy();
    if (!ymlPath) return null;
    try {
      const text = await fetch(ymlPath).then(r=>r.text());
      return { path: ymlPath, data: jsyaml.load(text) };
    } catch { return null; }
  }

  modelBadge.textContent='Loading…';
  const result = await loadYamlFile();
  if (!result) { modelBadge.textContent='No YAML'; errEl.style.display=''; return; }

  const y=result.data||{};
  modelBadge.textContent=pickModel(y);

  if (typeof y.prompt==='string') addBlock('Prompt',y.prompt);
  if (typeof y.system_prompt==='string') addBlock('System Prompt',y.system_prompt);
  if (typeof y.user_prompt==='string') addBlock('User Prompt',y.user_prompt);
  if (typeof y.instructions==='string') addBlock('Instructions',y.instructions);
  if (Array.isArray(y.prompts)) y.prompts.forEach((p,i)=>addBlock(`Prompt ${i+1}`,typeof p==='string'?p:JSON.stringify(p,null,2)));
  if (Array.isArray(y.messages)) addMessages(y.messages);
  if (Array.isArray(y.chat)) addMessages(y.chat);

  // small meta parameters
  const metaKeys=['temperature','top_p','seed','max_tokens','stop'];
  const dl=document.createElement('dl');dl.className='meta-kv';
  metaKeys.forEach(k=>{
    const v=y[k]??y?.config?.[k]??y?.params?.[k];
    if(v!==undefined){const dt=document.createElement('dt');dt.textContent=k;
      const dd=document.createElement('dd');dd.textContent=String(v);dl.append(dt,dd);}
  });
  if(dl.children.length){meta.append(dl);}
})();
</script>
</body>
</html>
